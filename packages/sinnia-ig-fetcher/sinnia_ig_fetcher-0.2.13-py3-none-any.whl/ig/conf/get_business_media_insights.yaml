
graph_api:
  # https://developers.facebook.com/docs/instagram-api/reference/media/insights
  # Requesting metrics not available for a media type results in error
  host:               'https://graph.facebook.com/v11.0'
  request_image_path: '/{media_id}/insights?metric=engagement,impressions,reach,saved'
  request_video_path: '/{media_id}/insights?metric=engagement,impressions,reach,saved,video_views'
  request_carousel_album_path: '/{media_id}/insights?metric=carousel_album_engagement,carousel_album_impressions,carousel_album_reach,carousel_album_saved,carousel_album_video_views'
  request_story_path: '/{media_id}/insights?metric=exits,impressions,reach,replies,taps_forward,taps_back'
  
  
queries:
  get_media: |    
    SELECT ua.instagram_id, m.id, m.type, m.is_story, ua.access_token
    FROM UsersAuth ua 
    JOIN UserAuthsInClient uac ON uac.instagram_id = ua.instagram_id
    JOIN Clients c ON uac.client_id = c.id
    JOIN Media m ON m.user_id=ua.instagram_id
    WHERE data_access_until > CURRENT_TIMESTAMP()
    AND ua.instagram_id IS NOT NULL
    AND uac.active = 1 AND ua.active = 1
    AND c.service_level != "DEACTIVATED"
    AND m.created_at >= DATE_ADD(now(), INTERVAL -15 DAY)
    AND m.is_story = 0    
    UNION
    SELECT ua.instagram_id, m.id, m.type, m.is_story, ua.access_token
    FROM UsersAuth ua 
    JOIN UserAuthsInClient uac ON uac.instagram_id = ua.instagram_id
    JOIN Clients c ON uac.client_id = c.id
    JOIN Media m ON m.user_id=ua.instagram_id
    WHERE data_access_until > CURRENT_TIMESTAMP()
    AND ua.instagram_id IS NOT NULL
    AND uac.active = 1 AND ua.active = 1
    AND c.service_level != "DEACTIVATED"
    AND m.created_at >= DATE_ADD(now(), INTERVAL -1 DAY)
    AND m.is_story = 1

  get_media_by_user: |    
    SELECT ua.instagram_id, m.id, m.type, m.is_story, ua.access_token
    FROM UsersAuth ua 
    JOIN UserAuthsInClient uac ON uac.instagram_id = ua.instagram_id
    JOIN Clients c ON uac.client_id = c.id
    JOIN Media m ON m.user_id=ua.instagram_id
    WHERE data_access_until > CURRENT_TIMESTAMP()
    AND ua.instagram_id IS NOT NULL
    AND uac.active = 1 AND ua.active = 1
    AND c.service_level != "DEACTIVATED"
    AND m.created_at >= DATE_ADD(now(), INTERVAL -{days} DAY)
    AND m.is_story = 0
    AND ua.instagram_id = {user_id}
    UNION
    SELECT ua.instagram_id, m.id, m.type, m.is_story, ua.access_token
    FROM UsersAuth ua 
    JOIN UserAuthsInClient uac ON uac.instagram_id = ua.instagram_id
    JOIN Clients c ON uac.client_id = c.id
    JOIN Media m ON m.user_id=ua.instagram_id
    WHERE data_access_until > CURRENT_TIMESTAMP()
    AND ua.instagram_id IS NOT NULL
    AND uac.active = 1 AND ua.active = 1
    AND c.service_level != "DEACTIVATED"
    AND m.created_at >= DATE_ADD(now(), INTERVAL -1 DAY)
    AND m.is_story = 1
    AND ua.instagram_id = {user_id}
    
  insert_insights: |
    INSERT INTO MediaInsights(user_id, media_id, end_time, date, fetched_time,
    {metric_name})
    VALUES ({user_id}, '{media_id}', '{end_time}', '{date}', '{fetched_time}',
    {metric_value})
    ON DUPLICATE KEY UPDATE {metric_name}={metric_value}

    
db_config:
  ig:    
    host:    'sinnia-db-2-3.ce4bgmsedant.us-east-1.rds.amazonaws.com'
    db:      'vizgram'
    user:    'vizgram'
    passwd:  'vzig6-hanGR'
    charset: 'utf8mb4' 
  
